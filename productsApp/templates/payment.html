<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link
            rel="stylesheet"
            href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
            integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
            crossorigin="anonymous"
        />
        <script
            src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
            integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
            integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
            integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
            crossorigin="anonymous"
        ></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

        <!-- loading stripe.js -->
        <script src="https://js.stripe.com/v3/"></script>
        
        <link rel="stylesheet" href="bower_components/aos/dist/aos.css" />
        <script src="bower_components/aos/dist/aos.js"></script>
        <link
            href="https://fonts.googleapis.com/css?family=Nanum+Gothic:400,700,800"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="bower_components/aos/dist/aos.css" />
        <script src="bower_components/aos/dist/aos.js"></script>
        {% load static %}

        <!-- loading stripe components -->
        <!-- <script src="{% static 'payment/js/client.js' %}"></script> -->
        <link rel="stylesheet" href="{% static 'payment/css/global.css' %}" />


        <link
            rel="stylesheet"
            href="{% static 'productsApp/fonts/icomoon/style.css' %}"
        />
        <link
            rel="stylesheet"
            href="{% static 'productsApp/css/bootstrap.min.css' %}"
        />
        <link
            rel="stylesheet"
            href="{% static 'productsApp/css/magnific-popup.css' %}"
        />
        <link
            rel="stylesheet"
            href="{% static 'productsApp/css/jquery-ui.css' %}"
        />
        <link
            rel="stylesheet"
            href="{% static 'productsApp/css/owl.carousel.min.css' %}"
        />
        <link
            rel="stylesheet"
            href="{% static 'productsApp/css/owl.theme.default.min.css' %}"
        />
        <link
            rel="stylesheet"
            href="{% static 'productsApp/css/bootstrap-datepicker.css' %}"
        />
        <link
            rel="stylesheet"
            href="{% static 'productsApp/fonts/flaticon/font/flaticon.css' %}"
        />
        <!-- <link rel="stylesheet" href="{% static 'productsApp/css/aos.css' %}"> -->
        <link
            rel="stylesheet"
            href="{% static 'productsApp/css/rangeslider.css' %}"
        />
        <link
            rel="stylesheet"
            href="{% static 'productsApp/css/style.css' %}"
        />

        <script src="{% static 'productsApp/js/jquery-3.3.1.min.js' %}"></script>
        <script src="{% static 'productsApp/js/jquery-migrate-3.0.1.min.js' %}"></script>
        <script src="{% static 'productsApp/js/jquery-ui.js' %}"></script>
        <script src="{% static 'productsApp/js/popper.min.js' %}"></script>
        <script src="{% static 'productsApp/js/bootstrap.min.js' %}"></script>
        <script src="{% static 'productsApp/js/owl.carousel.min.js' %}"></script>
        <script src="{% static 'productsApp/js/jquery.stellar.min.js' %}"></script>
        <script src="{% static 'productsApp/js/jquery.countdown.min.js' %}"></script>
        <script src="{% static 'productsApp/js/jquery.magnific-popup.min.js' %}"></script>
        <script src="{% static 'productsApp/js/bootstrap-datepicker.min.js' %}"></script>
        <!-- <script src="{% static 'productsApp/js/aos.js' %}"></script> -->
        <script src="{% static 'productsApp/js/rangeslider.min.js' %}"></script>
        <script src="{% static 'productsApp/js/main.js' %}"></script>
    </head>
    <body class="bg-white text-dark">
        <div class="site-wrap">
            <div class="site-mobile-menu">
                <div class="site-mobile-menu-header">
                    <div class="site-mobile-menu-close mt-3">
                        <span class="icon-close2 js-menu-toggle"></span>
                    </div>
                </div>
                <div class="site-mobile-menu-body"></div>
            </div>
            <header class="site-navbar container py-0 bg-white" role="banner">
                <div class="container">
                    <div class="row align-items-center">
                        <div class="col-6 col-xl-2">
                            <h1 class="mb-0 site-logo">
                                <a href="index.html" class="text-black mb-0"
                                    >OneStop<span class="text-primary"
                                        >Shop</span
                                    >
                                </a>
                            </h1>
                        </div>
                        <div class="col-12 col-md-10 d-none d-xl-block">
                            <nav
                                class="site-navigation position-relative text-right"
                                role="navigation"
                            >
                                <ul
                                    class="site-menu js-clone-nav mr-auto d-none d-lg-block"
                                >
                                    <li class="active">
                                        <a href="/home">Home</a>
                                    </li>
                                    <li>
                                        <a href="/user/{{user.id}}/shoppingCart"
                                            >Shopping Cart</a
                                        >
                                    </li>
                                    <li>
                                        <a href="/user/{{user.id}}/wishList"
                                            >Wish List</a
                                        >
                                    </li>
                                    <li class="has-children">
                                        <a href="#">Account</a>
                                        <ul class="dropdown">
                                            <li>
                                                <a
                                                    href="/user/myaccount/{{user.id}}"
                                                    >My Account</a
                                                >
                                            </li>
                                            <li>
                                                <a
                                                    href="/user/{{user.id}}/orders"
                                                    >My Orders</a
                                                >
                                            </li>
                                            <li>
                                                <a href="/user/logout"
                                                    >Logout</a
                                                >
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="ml-xl-3 login">
                                        <a href="/user/login"
                                            ><span
                                                class="border-left pl-xl-4"
                                            ></span
                                            >Log In</a
                                        >
                                    </li>
                                    <li>
                                        <a href="/user/register">Register</a>
                                    </li>
                                    <li>
                                        <a href="/products" class="cta"
                                            ><span
                                                class="bg-primary text-white rounded"
                                                >Product Listings</span
                                            ></a
                                        >
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>

                    <div
                        class="d-inline-block d-xl-none ml-auto py-3 col-6 text-right"
                        style="position: relative; top: 3px"
                    >
                        <a
                            href="#"
                            class="site-menu-toggle js-menu-toggle text-black"
                            ><span class="icon-menu h3"></span
                        ></a>
                    </div>
                </div>
            </header>

            <div class="site-section bg-light">
                <div class="container mt-5">
                    <div class="table">
                        <table
                            class="table table-striped table-bordered table-hover"
                        >
                            <thead class="thead-dark">
                                <tr>
                                    <th scope="col">Product</th>
                                    <th scope="col">Price</th>
                                    <th scope="col">Qty</th>
                                    <th scope="col">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in products.all %}
                                <tr>
                                    <td>{{product.name}}</td>
                                    <td>${{product.price}}</td>
                                    <td>1</td>
                                    <td></td>
                                </tr>
                                {% endfor %}
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>$20</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="accordion">
                        <div class="card">
                            <div class="card-header" id="headingOne">
                                <h5 class="mb-0">
                                    <button
                                        class="btn btn-link"
                                        data-toggle="collapse"
                                        data-target="#collapseOne"
                                        aria-expanded="true"
                                        aria-controls="collapseOne"
                                    >
                                        1. Shipping
                                    </button>
                                </h5>
                            </div>
                            <div
                                id="collapseOne"
                                class="collapse show"
                                aria-labelledby="headingOne"
                                data-parent="#accordion"
                            >
                                <div class="card-body">
                                    <h1>Shipping information</h1>
                                <div class="labels">
                                    <label>First Name</label>
                                    <input
                                        type="text"
                                        name="shipping_firstName"
                                        class="col-sm-6 form-control"
                                    />
                                    <label>Last Name</label>
                                    <input
                                        type="text"
                                        name="shipping_lastName"
                                        class="col-sm-6 form-control"
                                    />
                                    <label>Address</label>
                                    <input
                                        type="text"
                                        name="shipping_address"
                                        class="col-sm-6 form-control"
                                    />
                                    <label>Adresss 2</label>
                                    <input
                                        type="text"
                                        name="shipping_address2"
                                        class="col-sm-6 form-control"
                                    />
                                    <label>City</label>
                                    <input
                                        type="text"
                                        name="shipping_city"
                                        class="col-sm-6 form-control"
                                    />
                                    <label>State</label>
                                    <input
                                        type="text"
                                        name="shipping_state"
                                        class="col-sm-6 form-control"
                                    />
                                    <label>Zipcode</label>
                                    <input
                                        type="text"
                                        name="shipping_zipcode"
                                        class="col-sm-6 form-control"
                                    />
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header" id="headingTwo">
                                <h5 class="mb-0">
                                    <button
                                        class="btn btn-link collapsed"
                                        data-toggle="collapse"
                                        data-target="#collapseTwo"
                                        aria-expanded="false"
                                        aria-controls="collapseTwo"
                                    >
                                        2. Billing
                                    </button>
                                </h5>
                            </div>
                            <div
                                id="collapseTwo"
                                class="collapse"
                                aria-labelledby="headingTwo"
                                data-parent="#accordion"
                            >
                                <div class="card-body">
                                    <div class="sr-root">
                                        <div class="sr-main">
                                            <form id="payment-form" class="sr-payment-form">
                                                {% csrf_token %}
                                                <div class="sr-combo-inputs-row">
                                                    <div class="sr-input sr-card-element" id="card-element">
                                                        <!--Stripe.js injects the Card Element-->
                                                    </div>
                                                </div>
                                                <div class="sr-field-error" id="card-errors"></div>
                                                <button id="submit" class="btn">
                                                    <div class="spinner-border spinner-border-sm text-light hidden" id="spinner" role="status">
                                                        <span class="sr-only">Loading...</span>
                                                    </div>
                                                    <span id="button-text">Pay</span>
                                                </button>
                                                <p id="card-error" role="alert"></p>
                                                <p class="result-message hidden">
                                                    Payment succeeded, see the result in your
                                                    <a href="" target="_blank">Stripe dashboard.</a>
                                                    Refresh the page to pay again.
                                                </p>
                                            </form>
                                            <div class="sr-result hidden">
                                                <p>Payment completed</p>
                                                <pre>
                                                    <code></code>
                                                </pre>
                                            </div>
                                        </div>
                                    </div>
                                    <form id="payload" class="hidden" action="user/{{User.id}}/paymentComplete/paymentComplete" method="POST">
                                        {% csrf_token %}
                                        <input id="data-payload" type="hidden" name="payload">
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header" id="headingThree">
                                <h5 class="mb-0">
                                    <button
                                        class="btn btn-link collapsed"
                                        data-toggle="collapse"
                                        data-target="#collapseThree"
                                        aria-expanded="false"
                                        aria-controls="collapseThree"
                                    >
                                        3. Review
                                    </button>
                                </h5>
                            </div>
                            <div
                                id="collapseThree"
                                class="collapse"
                                aria-labelledby="headingThree"
                                data-parent="#accordion"
                            >
                                <div class="card-body">
                                    This is the review page!
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script type="text/javascript">
        // A reference to Stripe.js initialized with your real test publishable API key.
        var stripe = Stripe(
            'pk_test_51GuRsoCHa7tWmaIpCliv1INqTrABvAiPwQkef1fZ2ZegWptiBWPJf34SrGVxyf3NMqO1ZrINg7E1azIaUNiqQ8KP00jSPXRv0P'
        );

        var orderData = {
            items: [{ id: "products" }],
            currency: "usd",
        };

        // Disable the button until we have Stripe set up on the page
        document.getElementById("submit").disabled = true;

        fetch("/user/{{User.id}}/createPaymentIntent", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(orderData)
        })
            .then(function(result) {
                return result.json();
            })
            .then(function(data) {
                return setupElements(data);
            })
            .then(function({ stripe, card, clientSecret }) {
                document.getElementById("submit").disabled = false;

                card.on("change", function(event) {
                    document.querySelector("button").disabled = event.empty;
                    document.querySelector("#card-error").textContent = event.error ? event.error.message : "";
                });

                // Handle form submission.
                var form = document.getElementById("payment-form");
                form.addEventListener("submit", function(event) {
                event.preventDefault();
                // Initiate payment when the submit button is clicked
                payWithCard(stripe, card, clientSecret);
                });
            });

        // Set up Stripe.js and Elements to use in checkout form
        var setupElements = function(data) {
            // stripe = Stripe(data.publishableKey);
            var elements = stripe.elements();
            var style = {
                base: {
                color: "#32325d",
                fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                fontSmoothing: "antialiased",
                fontSize: "16px",
                "::placeholder": {
                    color: "#aab7c4"
                }
                },
                invalid: {
                color: "#fa755a",
                iconColor: "#fa755a"
                }
            };

            var card = elements.create("card", { style: style });
            card.mount("#card-element");

            return {
                stripe: stripe,
                card: card,
                clientSecret: data.clientSecret
            };
        };

        /*
        * Calls stripe.confirmCardPayment which creates a pop-up modal to
        * prompt the user to enter extra authentication details without leaving your page
        */
        var payWithCard = function(stripe, card, clientSecret) {
            changeLoadingState(true);

            // Initiate the payment.
            // If authentication is required, confirmCardPayment will automatically display a modal
            stripe
                .confirmCardPayment(clientSecret, {
                payment_method: {
                    card: card
                }
                })
                .then(function(result) {
                if (result.error) {
                    // Show error to your customer
                    showError(result.error.message);
                } else {
                    // The payment has been processed!
                    orderComplete(clientSecret);
                }
                });
        };

        /* ------- Post-payment helpers ------- */

        /* Shows a success / error message when the payment is complete */
        var orderComplete = function(clientSecret) {
            // Just for the purpose of the sample, show the PaymentIntent response object
            stripe.retrievePaymentIntent(clientSecret).then(function(result) {
                var paymentIntent = result.paymentIntent;
                var paymentIntentJson = JSON.stringify(paymentIntent, null, 2);
                
                // post data and show new page
                var form2 =document.getElementById("payload");
                var input = document.getElementById("data-payload")
                input.value = paymentIntentJson;
                form2.submit();
                changeLoadingState(false);
            });
        };

        var showError = function(errorMsgText) {
            changeLoadingState(false);
            var errorMsg = document.querySelector(".sr-field-error");
            errorMsg.textContent = errorMsgText;
            setTimeout(function() {
                errorMsg.textContent = "";
            }, 4000);
        };

        // Show a spinner on payment submission
        var changeLoadingState = function(isLoading) {
            if (isLoading) {
                document.getElementById("submit").disabled = true;
                document.querySelector("#spinner").classList.remove("hidden");
                document.querySelector("#button-text").classList.add("hidden");
            } else {
                document.getElementById("submit").disabled = false;
                document.querySelector("#spinner").classList.add("hidden");
                document.querySelector("#button-text").classList.remove("hidden");
            }
        };
    </script>
</html>
